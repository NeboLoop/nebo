name: Release

on:
  push:
    tags: ["v*"]

permissions:
  contents: write

env:
  GO_VERSION: "1.25"
  NODE_VERSION: "20"

jobs:
  # ─── Build frontend (shared by all platform builds) ───────────────────
  frontend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install pnpm
        run: npm install -g pnpm

      - name: Build frontend
        run: |
          cd app
          pnpm install --frozen-lockfile
          pnpm exec svelte-kit sync
          pnpm run build

      - name: Upload frontend build
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: app/build/
          retention-days: 1

  # ─── macOS desktop builds (CGO required for Wails v3) ─────────────────
  build-macos:
    needs: frontend
    strategy:
      matrix:
        include:
          - runner: macos-latest    # Apple Silicon (arm64)
            goarch: arm64
          - runner: macos-latest    # Cross-compile for Intel
            goarch: amd64
    runs-on: ${{ matrix.runner }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Download frontend build
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: app/build/

      - name: Build desktop binary
        env:
          GOOS: darwin
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: "1"
          MACOSX_DEPLOYMENT_TARGET: "13.0"
          CGO_CFLAGS: "-mmacosx-version-min=13.0"
          CGO_LDFLAGS: "-mmacosx-version-min=13.0"
        run: |
          go build -tags desktop \
            -ldflags="-w -s -X main.Version=${{ github.ref_name }}" \
            -o nebo-darwin-${{ matrix.goarch }} .

      - name: Import signing certificate
        if: env.APPLE_CERTIFICATE_P12 != ''
        env:
          APPLE_CERTIFICATE_P12: ${{ secrets.APPLE_CERTIFICATE_P12 }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        run: |
          KEYCHAIN_PATH=$RUNNER_TEMP/build.keychain-db
          security create-keychain -p "" "$KEYCHAIN_PATH"
          security set-keychain-settings "$KEYCHAIN_PATH"
          security unlock-keychain -p "" "$KEYCHAIN_PATH"
          echo "$APPLE_CERTIFICATE_P12" | base64 --decode > $RUNNER_TEMP/cert.p12
          security import $RUNNER_TEMP/cert.p12 -k "$KEYCHAIN_PATH" \
            -P "$APPLE_CERTIFICATE_PASSWORD" -T /usr/bin/codesign
          rm $RUNNER_TEMP/cert.p12
          security set-key-partition-list -S apple-tool:,apple: -s -k "" "$KEYCHAIN_PATH"
          security list-keychains -d user -s "$KEYCHAIN_PATH" login.keychain

      - name: Assemble Nebo.app bundle
        env:
          VERSION: ${{ github.ref_name }}
          SIGN_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
        run: |
          PKG_VERSION="${VERSION#v}"
          mkdir -p Nebo.app/Contents/MacOS
          mkdir -p Nebo.app/Contents/Resources
          cp nebo-darwin-${{ matrix.goarch }} Nebo.app/Contents/MacOS/nebo
          sed "s/__VERSION__/${PKG_VERSION}/g" assets/macos/Info.plist > Nebo.app/Contents/Info.plist
          cp assets/icons/nebo.icns Nebo.app/Contents/Resources/nebo.icns
          # Code sign if identity is available
          if [ -n "$SIGN_IDENTITY" ]; then
            codesign --force --sign "$SIGN_IDENTITY" \
              --identifier dev.neboloop.nebo \
              --entitlements assets/macos/nebo.entitlements \
              --options runtime \
              Nebo.app/Contents/MacOS/nebo
            codesign --force --sign "$SIGN_IDENTITY" \
              --identifier dev.neboloop.nebo \
              --entitlements assets/macos/nebo.entitlements \
              --options runtime \
              Nebo.app
            echo "Nebo.app signed with Developer ID"
          fi

      - name: Create .dmg installer
        env:
          VERSION: ${{ github.ref_name }}
        run: |
          brew install create-dmg
          # Move Nebo.app into dist/ so the script can find it
          mkdir -p dist
          cp -R Nebo.app dist/Nebo.app
          chmod +x scripts/create-dmg.sh
          ./scripts/create-dmg.sh "$VERSION" "${{ matrix.goarch }}"

      - name: Notarize .dmg
        if: env.APPLE_ID != ''
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_PASSWORD: ${{ secrets.APPLE_APP_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          DMG_FILE=$(ls dist/Nebo-*.dmg)
          echo "Submitting $DMG_FILE for notarization..."
          xcrun notarytool submit "$DMG_FILE" \
            --apple-id "$APPLE_ID" \
            --password "$APPLE_APP_PASSWORD" \
            --team-id "$APPLE_TEAM_ID" \
            --wait
          xcrun stapler staple "$DMG_FILE"
          echo "Notarization complete"

      - uses: actions/upload-artifact@v4
        with:
          name: nebo-darwin-${{ matrix.goarch }}
          path: dist/Nebo-*.dmg

  # ─── Linux desktop builds (CGO required for Wails v3 / WebKitGTK) ────
  build-linux:
    needs: frontend
    strategy:
      matrix:
        include:
          - runner: ubuntu-latest
            goarch: amd64
          - runner: ubuntu-24.04-arm
            goarch: arm64
    runs-on: ${{ matrix.runner }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Install Wails v3 Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgtk-3-dev \
            libwebkit2gtk-4.1-dev \
            pkg-config \
            build-essential

      - name: Download frontend build
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: app/build/

      - name: Build desktop binary
        env:
          GOOS: linux
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: "1"
        run: |
          go build -tags desktop \
            -ldflags="-w -s -X main.Version=${{ github.ref_name }}" \
            -o nebo-linux-${{ matrix.goarch }} .

      - uses: actions/upload-artifact@v4
        with:
          name: nebo-linux-${{ matrix.goarch }}
          path: nebo-linux-${{ matrix.goarch }}

  # ─── Linux headless builds (no CGO, no WebKitGTK dependency) ─────────
  build-linux-headless:
    needs: frontend
    strategy:
      matrix:
        include:
          - runner: ubuntu-latest
            goarch: amd64
          - runner: ubuntu-24.04-arm
            goarch: arm64
    runs-on: ${{ matrix.runner }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Download frontend build
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: app/build/

      - name: Build headless binary
        env:
          GOOS: linux
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: "0"
        run: |
          go build \
            -ldflags="-w -s -X main.Version=${{ github.ref_name }}" \
            -o nebo-linux-${{ matrix.goarch }}-headless .

      - uses: actions/upload-artifact@v4
        with:
          name: nebo-linux-${{ matrix.goarch }}-headless
          path: nebo-linux-${{ matrix.goarch }}-headless

  # ─── Windows desktop build (CGO required for Wails v3 / WebView2) ────
  build-windows:
    needs: frontend
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: false

      - name: Download frontend build
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: app/build/

      - name: Build desktop binary
        env:
          GOOS: windows
          GOARCH: amd64
          CGO_ENABLED: "1"
        run: |
          go build -tags desktop `
            -ldflags="-w -s -X main.Version=${{ github.ref_name }}" `
            -o nebo-windows-amd64.exe .

      - uses: actions/upload-artifact@v4
        with:
          name: nebo-windows-amd64
          path: nebo-windows-amd64.exe

  # ─── Build Windows NSIS installer ─────────────────────────────────────
  package-windows:
    needs: build-windows
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download Windows binary
        uses: actions/download-artifact@v4
        with:
          name: nebo-windows-amd64
          path: .

      - name: Install NSIS
        run: choco install nsis -y

      - name: Create dist directory
        run: mkdir dist

      - name: Build installer
        env:
          VERSION: ${{ github.ref_name }}
        run: |
          $PkgVersion = "$env:VERSION" -replace '^v',''
          & "C:\Program Files (x86)\NSIS\makensis.exe" /DVERSION=$PkgVersion /DEXE_PATH=..\nebo-windows-amd64.exe scripts\installer.nsi

      - name: Sign Windows binaries (Authenticode)
        if: vars.AZURE_SIGNING_ENABLED == 'true'
        uses: azure/trusted-signing-action@v1
        with:
          azure-tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          azure-client-id: ${{ secrets.AZURE_CLIENT_ID }}
          azure-client-secret: ${{ secrets.AZURE_CLIENT_SECRET }}
          endpoint: ${{ vars.AZURE_SIGNING_ENDPOINT }}
          trusted-signing-account-name: ${{ vars.AZURE_SIGNING_ACCOUNT }}
          certificate-profile-name: ${{ vars.AZURE_SIGNING_PROFILE }}
          files-folder: ${{ github.workspace }}
          files-folder-filter: exe
          files-folder-depth: 2
          file-digest: SHA256
          timestamp-rfc3161: http://timestamp.acs.microsoft.com
          timestamp-digest: SHA256

      - uses: actions/upload-artifact@v4
        with:
          name: nebo-windows-installer
          path: dist/Nebo-*-setup.exe

      - uses: actions/upload-artifact@v4
        if: vars.AZURE_SIGNING_ENABLED == 'true'
        with:
          name: nebo-windows-amd64-signed
          path: nebo-windows-amd64.exe

  # ─── Build .deb packages ──────────────────────────────────────────────
  package-deb:
    needs: build-linux
    strategy:
      matrix:
        include:
          - goarch: amd64
            nfpm_arch: amd64
          - goarch: arm64
            nfpm_arch: arm64
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download linux binary
        uses: actions/download-artifact@v4
        with:
          name: nebo-linux-${{ matrix.goarch }}
          path: .

      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Make binary executable
        run: chmod +x nebo-linux-${{ matrix.goarch }}

      - name: Install nfpm
        run: go install github.com/goreleaser/nfpm/v2/cmd/nfpm@latest

      - name: Build .deb package
        env:
          VERSION: ${{ github.ref_name }}
          ARCH: ${{ matrix.nfpm_arch }}
          GOARCH: ${{ matrix.goarch }}
        run: |
          # Strip v prefix for package version
          PKG_VERSION="${VERSION#v}"
          # Create nfpm config from template
          sed -e "s/__VERSION__/${PKG_VERSION}/g" \
              -e "s/__ARCH__/${ARCH}/g" \
              -e "s/__GOARCH__/${GOARCH}/g" \
              nfpm.yaml.tmpl > nfpm.yaml
          nfpm pkg --packager deb --target nebo_${PKG_VERSION}_${ARCH}.deb

      - uses: actions/upload-artifact@v4
        with:
          name: nebo-deb-${{ matrix.goarch }}
          path: "*.deb"

  # ─── Create GitHub release with all artifacts ─────────────────────────
  release:
    needs: [build-macos, build-linux, build-linux-headless, build-windows, package-deb, package-windows]
    if: ${{ !cancelled() }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: nebo-*
          merge-multiple: true

      - name: List artifacts
        run: ls -la artifacts/

      - name: Make binaries executable
        run: chmod +x artifacts/nebo-* 2>/dev/null || true

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/*
          generate_release_notes: true
          draft: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ─── Update Homebrew cask (cross-repo) ────────────────────────────────
  update-homebrew:
    if: ${{ vars.HAS_TAP_TOKEN == 'true' }}
    needs: release
    runs-on: ubuntu-latest
    steps:
      - name: Download macOS artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: nebo-darwin-*
          merge-multiple: true

      - name: Compute SHA256 checksums
        id: checksums
        run: |
          echo "darwin_arm64=$(sha256sum artifacts/Nebo-*-arm64.dmg | awk '{print $1}')" >> "$GITHUB_OUTPUT"
          echo "darwin_amd64=$(sha256sum artifacts/Nebo-*-amd64.dmg | awk '{print $1}')" >> "$GITHUB_OUTPUT"

      - name: Checkout homebrew-tap
        uses: actions/checkout@v4
        with:
          repository: neboloop/homebrew-tap
          token: ${{ secrets.TAP_GITHUB_TOKEN }}
          path: homebrew-tap

      - name: Checkout source (for cask template)
        uses: actions/checkout@v4
        with:
          path: source

      - name: Update cask
        env:
          VERSION: ${{ github.ref_name }}
          SHA_DARWIN_ARM64: ${{ steps.checksums.outputs.darwin_arm64 }}
          SHA_DARWIN_AMD64: ${{ steps.checksums.outputs.darwin_amd64 }}
        run: |
          export PKG_VERSION="${VERSION#v}"
          mkdir -p homebrew-tap/Casks
          envsubst < source/scripts/nebo.rb.tmpl > homebrew-tap/Casks/nebo.rb

      - name: Push cask update
        working-directory: homebrew-tap
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Casks/nebo.rb
          # Remove old formula if it exists
          git rm -f Formula/nebo.rb 2>/dev/null || true
          git commit -m "Update nebo to ${{ github.ref_name }}"
          git push

  # ─── Update APT repository (cross-repo) ──────────────────────────────
  update-apt:
    if: ${{ vars.HAS_TAP_TOKEN == 'true' }}
    needs: package-deb
    runs-on: ubuntu-latest
    steps:
      - name: Download .deb packages
        uses: actions/download-artifact@v4
        with:
          pattern: nebo-deb-*
          path: debs
          merge-multiple: true

      - name: Checkout apt repo
        uses: actions/checkout@v4
        with:
          repository: neboloop/apt
          token: ${{ secrets.TAP_GITHUB_TOKEN }}
          path: apt-repo

      - name: Install APT repo tools
        run: sudo apt-get install -y dpkg-dev

      - name: Update APT repository
        run: |
          mkdir -p apt-repo/pool/main
          cp debs/*.deb apt-repo/pool/main/

          cd apt-repo

          # Generate Packages index
          mkdir -p dists/stable/main/binary-amd64
          mkdir -p dists/stable/main/binary-arm64

          dpkg-scanpackages pool/main /dev/null > dists/stable/main/binary-amd64/Packages
          dpkg-scanpackages pool/main /dev/null > dists/stable/main/binary-arm64/Packages
          gzip -k dists/stable/main/binary-amd64/Packages
          gzip -k dists/stable/main/binary-arm64/Packages

          # Generate Release file
          cat > dists/stable/Release << 'EOF'
          Origin: Nebo
          Label: Nebo
          Suite: stable
          Codename: stable
          Architectures: amd64 arm64
          Components: main
          Description: Nebo AI Agent
          EOF
          # Remove leading whitespace from heredoc
          sed -i 's/^          //' dists/stable/Release

          apt-ftparchive release dists/stable >> dists/stable/Release

      - name: Sign APT repository
        if: env.GPG_KEY != ''
        env:
          GPG_KEY: ${{ secrets.APT_GPG_PRIVATE_KEY }}
        run: |
          echo "$GPG_KEY" | gpg --import
          gpg --armor --export > apt-repo/key.gpg
          gpg --default-key nebo -abs -o apt-repo/dists/stable/Release.gpg apt-repo/dists/stable/Release
          gpg --default-key nebo --clearsign -o apt-repo/dists/stable/InRelease apt-repo/dists/stable/Release

      - name: Push APT repo update
        working-directory: apt-repo
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "Update nebo to ${{ github.ref_name }}" || echo "No changes"
          git push
