// Code generated by sqlc. DO NOT EDIT.
// versions:
//   sqlc v1.30.0
// source: auth_profiles.sql

package db

import (
	"context"
	"database/sql"
)

const createAuthProfile = `-- name: CreateAuthProfile :one

INSERT INTO auth_profiles (id, name, provider, api_key, model, base_url, priority, is_active, auth_type, metadata, created_at, updated_at)
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, unixepoch(), unixepoch())
RETURNING id, name, provider, api_key, model, base_url, priority, is_active, cooldown_until, last_used_at, usage_count, error_count, metadata, created_at, updated_at, auth_type
`

type CreateAuthProfileParams struct {
	ID       string         `json:"id"`
	Name     string         `json:"name"`
	Provider string         `json:"provider"`
	ApiKey   string         `json:"api_key"`
	Model    sql.NullString `json:"model"`
	BaseUrl  sql.NullString `json:"base_url"`
	Priority sql.NullInt64  `json:"priority"`
	IsActive sql.NullInt64  `json:"is_active"`
	AuthType sql.NullString `json:"auth_type"`
	Metadata sql.NullString `json:"metadata"`
}

// Auth profiles queries
func (q *Queries) CreateAuthProfile(ctx context.Context, arg CreateAuthProfileParams) (AuthProfile, error) {
	row := q.db.QueryRowContext(ctx, createAuthProfile,
		arg.ID,
		arg.Name,
		arg.Provider,
		arg.ApiKey,
		arg.Model,
		arg.BaseUrl,
		arg.Priority,
		arg.IsActive,
		arg.AuthType,
		arg.Metadata,
	)
	var i AuthProfile
	err := row.Scan(
		&i.ID,
		&i.Name,
		&i.Provider,
		&i.ApiKey,
		&i.Model,
		&i.BaseUrl,
		&i.Priority,
		&i.IsActive,
		&i.CooldownUntil,
		&i.LastUsedAt,
		&i.UsageCount,
		&i.ErrorCount,
		&i.Metadata,
		&i.CreatedAt,
		&i.UpdatedAt,
		&i.AuthType,
	)
	return i, err
}

const deleteAuthProfile = `-- name: DeleteAuthProfile :exec
DELETE FROM auth_profiles WHERE id = ?
`

func (q *Queries) DeleteAuthProfile(ctx context.Context, id string) error {
	_, err := q.db.ExecContext(ctx, deleteAuthProfile, id)
	return err
}

const getAuthProfile = `-- name: GetAuthProfile :one
SELECT id, name, provider, api_key, model, base_url, priority, is_active, cooldown_until, last_used_at, usage_count, error_count, metadata, created_at, updated_at, auth_type FROM auth_profiles WHERE id = ?
`

func (q *Queries) GetAuthProfile(ctx context.Context, id string) (AuthProfile, error) {
	row := q.db.QueryRowContext(ctx, getAuthProfile, id)
	var i AuthProfile
	err := row.Scan(
		&i.ID,
		&i.Name,
		&i.Provider,
		&i.ApiKey,
		&i.Model,
		&i.BaseUrl,
		&i.Priority,
		&i.IsActive,
		&i.CooldownUntil,
		&i.LastUsedAt,
		&i.UsageCount,
		&i.ErrorCount,
		&i.Metadata,
		&i.CreatedAt,
		&i.UpdatedAt,
		&i.AuthType,
	)
	return i, err
}

const getAuthProfileByName = `-- name: GetAuthProfileByName :one
SELECT id, name, provider, api_key, model, base_url, priority, is_active, cooldown_until, last_used_at, usage_count, error_count, metadata, created_at, updated_at, auth_type FROM auth_profiles WHERE name = ?
`

func (q *Queries) GetAuthProfileByName(ctx context.Context, name string) (AuthProfile, error) {
	row := q.db.QueryRowContext(ctx, getAuthProfileByName, name)
	var i AuthProfile
	err := row.Scan(
		&i.ID,
		&i.Name,
		&i.Provider,
		&i.ApiKey,
		&i.Model,
		&i.BaseUrl,
		&i.Priority,
		&i.IsActive,
		&i.CooldownUntil,
		&i.LastUsedAt,
		&i.UsageCount,
		&i.ErrorCount,
		&i.Metadata,
		&i.CreatedAt,
		&i.UpdatedAt,
		&i.AuthType,
	)
	return i, err
}

const getAuthProfileErrorCount = `-- name: GetAuthProfileErrorCount :one
SELECT error_count FROM auth_profiles WHERE id = ?
`

func (q *Queries) GetAuthProfileErrorCount(ctx context.Context, id string) (sql.NullInt64, error) {
	row := q.db.QueryRowContext(ctx, getAuthProfileErrorCount, id)
	var error_count sql.NullInt64
	err := row.Scan(&error_count)
	return error_count, err
}

const getBestAuthProfile = `-- name: GetBestAuthProfile :one
SELECT id, name, provider, api_key, model, base_url, priority, is_active, cooldown_until, last_used_at, usage_count, error_count, metadata, created_at, updated_at, auth_type FROM auth_profiles
WHERE provider = ? AND is_active = 1 AND (cooldown_until IS NULL OR cooldown_until < unixepoch())
ORDER BY
    CASE COALESCE(auth_type, 'api_key')
        WHEN 'oauth' THEN 0
        WHEN 'token' THEN 1
        WHEN 'api_key' THEN 2
        ELSE 3
    END ASC,
    priority DESC,
    COALESCE(last_used_at, 0) ASC,
    error_count ASC
LIMIT 1
`

// Get the best available profile for a provider
// Priority: auth_type (OAuth > Token > API Key), then priority, then round-robin by last_used_at
func (q *Queries) GetBestAuthProfile(ctx context.Context, provider string) (AuthProfile, error) {
	row := q.db.QueryRowContext(ctx, getBestAuthProfile, provider)
	var i AuthProfile
	err := row.Scan(
		&i.ID,
		&i.Name,
		&i.Provider,
		&i.ApiKey,
		&i.Model,
		&i.BaseUrl,
		&i.Priority,
		&i.IsActive,
		&i.CooldownUntil,
		&i.LastUsedAt,
		&i.UsageCount,
		&i.ErrorCount,
		&i.Metadata,
		&i.CreatedAt,
		&i.UpdatedAt,
		&i.AuthType,
	)
	return i, err
}

const listActiveAuthProfilesByProvider = `-- name: ListActiveAuthProfilesByProvider :many
SELECT id, name, provider, api_key, model, base_url, priority, is_active, cooldown_until, last_used_at, usage_count, error_count, metadata, created_at, updated_at, auth_type FROM auth_profiles
WHERE provider = ? AND is_active = 1 AND (cooldown_until IS NULL OR cooldown_until < unixepoch())
ORDER BY
    CASE COALESCE(auth_type, 'api_key')
        WHEN 'oauth' THEN 0
        WHEN 'token' THEN 1
        WHEN 'api_key' THEN 2
        ELSE 3
    END ASC,
    priority DESC,
    COALESCE(last_used_at, 0) ASC,
    error_count ASC
`

// Returns active profiles NOT on cooldown - for request-level profile selection.
func (q *Queries) ListActiveAuthProfilesByProvider(ctx context.Context, provider string) ([]AuthProfile, error) {
	rows, err := q.db.QueryContext(ctx, listActiveAuthProfilesByProvider, provider)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var items []AuthProfile
	for rows.Next() {
		var i AuthProfile
		if err := rows.Scan(
			&i.ID,
			&i.Name,
			&i.Provider,
			&i.ApiKey,
			&i.Model,
			&i.BaseUrl,
			&i.Priority,
			&i.IsActive,
			&i.CooldownUntil,
			&i.LastUsedAt,
			&i.UsageCount,
			&i.ErrorCount,
			&i.Metadata,
			&i.CreatedAt,
			&i.UpdatedAt,
			&i.AuthType,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Close(); err != nil {
		return nil, err
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const listAllActiveAuthProfilesByProvider = `-- name: ListAllActiveAuthProfilesByProvider :many
SELECT id, name, provider, api_key, model, base_url, priority, is_active, cooldown_until, last_used_at, usage_count, error_count, metadata, created_at, updated_at, auth_type FROM auth_profiles
WHERE provider = ? AND is_active = 1
ORDER BY
    CASE COALESCE(auth_type, 'api_key')
        WHEN 'oauth' THEN 0
        WHEN 'token' THEN 1
        WHEN 'api_key' THEN 2
        ELSE 3
    END ASC,
    priority DESC
`

// Returns ALL active profiles regardless of cooldown - for provider loading.
// Cooldown affects request routing, not provider existence.
func (q *Queries) ListAllActiveAuthProfilesByProvider(ctx context.Context, provider string) ([]AuthProfile, error) {
	rows, err := q.db.QueryContext(ctx, listAllActiveAuthProfilesByProvider, provider)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var items []AuthProfile
	for rows.Next() {
		var i AuthProfile
		if err := rows.Scan(
			&i.ID,
			&i.Name,
			&i.Provider,
			&i.ApiKey,
			&i.Model,
			&i.BaseUrl,
			&i.Priority,
			&i.IsActive,
			&i.CooldownUntil,
			&i.LastUsedAt,
			&i.UsageCount,
			&i.ErrorCount,
			&i.Metadata,
			&i.CreatedAt,
			&i.UpdatedAt,
			&i.AuthType,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Close(); err != nil {
		return nil, err
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const listAuthProfiles = `-- name: ListAuthProfiles :many
SELECT id, name, provider, api_key, model, base_url, priority, is_active, cooldown_until, last_used_at, usage_count, error_count, metadata, created_at, updated_at, auth_type FROM auth_profiles ORDER BY provider, priority DESC
`

func (q *Queries) ListAuthProfiles(ctx context.Context) ([]AuthProfile, error) {
	rows, err := q.db.QueryContext(ctx, listAuthProfiles)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var items []AuthProfile
	for rows.Next() {
		var i AuthProfile
		if err := rows.Scan(
			&i.ID,
			&i.Name,
			&i.Provider,
			&i.ApiKey,
			&i.Model,
			&i.BaseUrl,
			&i.Priority,
			&i.IsActive,
			&i.CooldownUntil,
			&i.LastUsedAt,
			&i.UsageCount,
			&i.ErrorCount,
			&i.Metadata,
			&i.CreatedAt,
			&i.UpdatedAt,
			&i.AuthType,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Close(); err != nil {
		return nil, err
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const resetAuthProfileErrorCountIfStale = `-- name: ResetAuthProfileErrorCountIfStale :exec
UPDATE auth_profiles
SET error_count = 0, updated_at = unixepoch()
WHERE id = ?
AND error_count > 0
AND (cooldown_until IS NULL OR cooldown_until < unixepoch())
AND updated_at < ?
`

type ResetAuthProfileErrorCountIfStaleParams struct {
	ID        string `json:"id"`
	UpdatedAt int64  `json:"updated_at"`
}

// Reset error count if cooldown has expired and last update was > 24h ago
func (q *Queries) ResetAuthProfileErrorCountIfStale(ctx context.Context, arg ResetAuthProfileErrorCountIfStaleParams) error {
	_, err := q.db.ExecContext(ctx, resetAuthProfileErrorCountIfStale, arg.ID, arg.UpdatedAt)
	return err
}

const setAuthProfileCooldown = `-- name: SetAuthProfileCooldown :exec
UPDATE auth_profiles
SET cooldown_until = ?, updated_at = unixepoch()
WHERE id = ?
`

type SetAuthProfileCooldownParams struct {
	CooldownUntil sql.NullInt64 `json:"cooldown_until"`
	ID            string        `json:"id"`
}

func (q *Queries) SetAuthProfileCooldown(ctx context.Context, arg SetAuthProfileCooldownParams) error {
	_, err := q.db.ExecContext(ctx, setAuthProfileCooldown, arg.CooldownUntil, arg.ID)
	return err
}

const toggleAuthProfile = `-- name: ToggleAuthProfile :exec
UPDATE auth_profiles
SET is_active = ?, updated_at = unixepoch()
WHERE id = ?
`

type ToggleAuthProfileParams struct {
	IsActive sql.NullInt64 `json:"is_active"`
	ID       string        `json:"id"`
}

func (q *Queries) ToggleAuthProfile(ctx context.Context, arg ToggleAuthProfileParams) error {
	_, err := q.db.ExecContext(ctx, toggleAuthProfile, arg.IsActive, arg.ID)
	return err
}

const updateAuthProfile = `-- name: UpdateAuthProfile :exec
UPDATE auth_profiles
SET name = ?, api_key = ?, model = ?, base_url = ?, priority = ?, auth_type = ?, metadata = ?, updated_at = unixepoch()
WHERE id = ?
`

type UpdateAuthProfileParams struct {
	Name     string         `json:"name"`
	ApiKey   string         `json:"api_key"`
	Model    sql.NullString `json:"model"`
	BaseUrl  sql.NullString `json:"base_url"`
	Priority sql.NullInt64  `json:"priority"`
	AuthType sql.NullString `json:"auth_type"`
	Metadata sql.NullString `json:"metadata"`
	ID       string         `json:"id"`
}

func (q *Queries) UpdateAuthProfile(ctx context.Context, arg UpdateAuthProfileParams) error {
	_, err := q.db.ExecContext(ctx, updateAuthProfile,
		arg.Name,
		arg.ApiKey,
		arg.Model,
		arg.BaseUrl,
		arg.Priority,
		arg.AuthType,
		arg.Metadata,
		arg.ID,
	)
	return err
}

const updateAuthProfileError = `-- name: UpdateAuthProfileError :exec
UPDATE auth_profiles
SET error_count = error_count + 1, updated_at = unixepoch()
WHERE id = ?
`

func (q *Queries) UpdateAuthProfileError(ctx context.Context, id string) error {
	_, err := q.db.ExecContext(ctx, updateAuthProfileError, id)
	return err
}

const updateAuthProfileUsage = `-- name: UpdateAuthProfileUsage :exec
UPDATE auth_profiles
SET last_used_at = unixepoch(), usage_count = usage_count + 1, error_count = 0, updated_at = unixepoch()
WHERE id = ?
`

func (q *Queries) UpdateAuthProfileUsage(ctx context.Context, id string) error {
	_, err := q.db.ExecContext(ctx, updateAuthProfileUsage, id)
	return err
}
